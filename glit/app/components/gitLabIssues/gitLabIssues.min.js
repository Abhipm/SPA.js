spa.component("gitLabIssues",{target:"#tabContainer_gitLabIssues"}),spa.extendComponent("gitLabIssues",{controlActionButtonsEnabled:!1,tableSelector:"#gitLabIssues",sourceData:[],apiStatus_List:"",jqXHR_List:void 0,cCount:0,wCount:0,prjMilestonesRaw:[],prjMilestones:{},prjMembersRaw:[],prjMembers:{},prjLabelsRaw:[],prjLabels:{},prjLblColor:{},lastClickedIssueId:"",inViewIssueId:"",ajaxTimer:new Timer,timerContainer:void 0,progressMsgContainer:void 0,toListLayoutIcon:"list",renderCallback:function(){"use strict";$("#container_gitLabIssues").addClass("hide"),app.gitLabIssues.milestonesList(),app.gitLabIssues.membersList(),app.gitLabIssues.labelsList(),app.gitLabIssues.progressMsgContainer=$("#container_gitLabIssues #progressMsg"),app.gitLabIssues.timerContainer=$("#container_gitLabIssues #containerTimer"),app.gitLabIssues.ajaxTimer.addEventListener("secondsUpdated",function(){app.gitLabIssues.timerContainer.html(app.gitLabIssues.ajaxTimer.getTimeValues().toString(["minutes","seconds","secondTenths"]))})},milestonesList:function(){spa.api.get(spa.api.url("@gitLabProjMilestones",{pid:app.activeGitLab.pid}),function(e){app.gitLabIssues.prjMilestonesRaw=e,app.gitLabIssues.prjMilestones={},spa.isBlank(e)||_.each(e,function(e){app.gitLabIssues.prjMilestones[e.id]=e.title})})},membersList:function(){spa.api.get(spa.api.url("@gitLabProjectMembers",{pid:app.activeGitLab.pid}),function(e){app.gitLabIssues.prjMembersRaw=e,app.gitLabIssues.prjMembers={},spa.isBlank(e)||_.each(e,function(e){app.gitLabIssues.prjMembers[e.id]=((e.name.containsStr(",")?e.name.split(",")[1]:e.name).trimStr().split(" ")[0]||e.username).toProperCase()})})},labelsList:function(){spa.api.get(spa.api.url("@gitLabProjLabels",{pid:app.activeGitLab.pid}),function(e){app.gitLabIssues.prjLabelsRaw=e,app.gitLabIssues.prjLabels={},app.gitLabIssues.prjLblColor={},spa.isBlank(e)||_.each(e,function(e){app.gitLabIssues.prjLabels[e.name]=e.name,app.gitLabIssues.prjLblColor[e.name]=e.color}),app.gitLabIssues.buildDataTable(),$("#container_gitLabIssues .dropdown").dropdown()})},pullIssues:function(e,s){$('[data-table-id="gitLabIssues"]').prop("disabled",!0).find("i.icon").addClass("loading"),app.uiHelper.indicateLoading("#btnIssuesFullRefresh, #btnIssuesFullRefreshLink","add");try{app.gitLabIssues.ajaxTimer.isRunning()||(app.uiHelper.indicateLoading("#iconTimer","add"),app.gitLabIssues.ajaxTimer.start({precision:"secondTenths",callback:function(e){app.gitLabIssues.timerContainer.html(e.toString(["minutes","seconds","secondTenths"]))}}))}catch(t){}spa.api.get(spa.api.url("@gitLabIssues",{pid:app.activeGitLab.pid,pgN:e||1}),s,function(t,a,i){_.each(t,function(e){app.gitLabIssues.sourceData.push(e)}),i.getAllResponseHeaders().containsStr('rel="next"')?($("#container_gitLabIssues #progressMsg").html("Received "+app.gitLabIssues.sourceData.length+" issues. Receiving more ... "),app.gitLabIssues.loadData(),app.gitLabIssues.pullIssues(e+1,s)):($("#container_gitLabIssues #progressMsg").html("Received "+app.gitLabIssues.sourceData.length+" issues."),app.gitLabIssues.loadData(),app.gitLabIssues.ajaxTimer.stop(),app.uiHelper.indicateLoading("#iconTimer","remove"))})},loadData:function(){app.gitLabIssues.cCount=0,app.gitLabIssues.wCount=0;var e=app.gitLabIssues.sourceData,s=app.gitLabIssues.tableSelector,t=dt.tableKey(s),a=dt.tableId(s);if(dt.tables.hasOwnProperty(t)){var i=dt.tables[t];i.clear(),i.rows.add(e).draw(),dt.registerExport(a),$('[data-table-id="'+t+'"]').prop("disabled",!1).find("i.icon").removeClass("loading"),app.uiHelper.indicateLoading("#btnIssuesFullRefresh, #btnIssuesFullRefreshLink","remove"),app.gitLabIssues.updateSeverityCounts()}else app.gitLabIssues.buildDataTable()},list:function(e){"use strict";var s={},t=spa.radioSelectedValue("#fmIssuesFilter","issuesFilter");t&&(s.state=t),$('[data-table-id="gitLabIssues"]').prop("disabled",!0).find("i.icon").addClass("loading"),app.uiHelper.indicateLoading("#btnIssuesFullRefresh, #btnIssuesFullRefreshLink","add"),e?(app.gitLabIssues.sourceData=[],$("#container_gitLabIssues #progressMsg").html("Receiving ... "),app.gitLabIssues.pullIssues(1,s)):app.gitLabIssues.loadData()},toLabelTags:function(e){return _.map(e,function(e){return'<span style="background:'+app.gitLabIssues.prjLblColor[e]+'">'+e+"</span>"})},buildDataTable:function(){app.uiHelper.indicateLoading("#btnIssuesFullRefresh, #btnIssuesFullRefreshLink","add");var e=app.gitLabIssues.tableSelector,s=dt.tableKey(e);if(dt.tables.hasOwnProperty(s)){var t=dt.tables[s];t.clear(),delete dt.tables[s]}$(e).html(""),dt.DataTable(e,{data:app.gitLabIssues.sourceData,scrollY:$("#mainContent").height()-250,columnDefs:[{targets:[0],orderable:!1,searchable:!1},{targets:[4],orderData:[9]},{targets:[9],visible:!1}],colVis:{exclude:[0,1,3,5,9]},aaSorting:[[4,"desc"]],"export":{iid:"IssueId",state:"State",id:"Severity",user_notes_count:"Status",labels:"Labels",author:"Author",project_id:"AssignedTo",created_at:"CreatedAt",updated_at:"UpdatedAt",milestone:"Milestone",upvotes:"Priority",title:"Title"},exportFormat:{id:function(e,s){return _.filter(s.labels,function(e){return app.conf.issueSeverityLabels.containsStrIgnoreCase(e)}).join(",")},user_notes_count:function(e,s){return _.filter(s.labels,function(e){return app.conf.issueStatusLabels.containsStrIgnoreCase(e)}).join(",")},author:function(e){return e.name||"Unknown"},project_id:function(e,s){var t=s.assignee||{name:"None"};return t.name||"None"},milestone:function(e){return spa.findSafe(e,"title","-")},upvotes:function(e,s){return _.filter(s.labels,function(e){return app.conf.issuePriorityLabels.containsStrIgnoreCase(e)}).join(",")}},createdRow:function(s,t,a){t._dtRowId=a;var i=$(s);i.data("rowData",t).attr("data-row-id",a).attr("data-issue-id",t.id);var n=_.filter(t.labels,function(e){return app.conf.issueSeverityLabels.containsStrIgnoreCase(e)});_.each(n,function(e){app.conf.issueLabelsGrp.CRITICAL.containsStrIgnoreCase(e)&&app.gitLabIssues.cCount++,app.conf.issueLabelsGrp.WARNING.containsStrIgnoreCase(e)&&app.gitLabIssues.wCount++}),i.on("click",function(){var s=$(this),t=(s.data("rowData"),s.data("rowId")),a=s.closest("tbody").find(":checkbox"),i=a.filter(":checked"),n=i.length>0,o=s.find(":checkbox");n?o.trigger("click"):(s.siblings().removeClass("selected"),s.addClass("selected"),dt.updateRowSelection(e),app.gitLabIssues.controlActionButtons(e),app.gitLabIssues.showDetails(t))}),i.find(":checkbox").on("click",function(s){var t=($(this),$(e+"_wrapper tbody").find(":checkbox:checked").closest("tr")),a=$(e+"_wrapper tbody").find(":checkbox:not(:checked)").closest("tr"),i=(t.length>0,_.map(a,function(e){return $(e).data("rowId")})),n=_.map(t,function(e){return $(e).data("rowId")}),o=dt.tables[dt.tableKey(e)];a.removeClass("selected"),t.addClass("selected"),spa.isBlank(i)||o.rows(i).deselect(),spa.isBlank(n)||o.rows(n).select(!0),app.gitLabIssues.controlActionButtons(e),1==t.length&&app.gitLabIssues.showDetails(t.data("rowId")),s.stopPropagation()})},columns:[{width:"15",title:'<input type="checkbox" class="CHECK-ALL-NONE" onclick="dt.selectAllNone(\''+e+"', this);app.gitLabIssues.controlActionButtons('"+e+"');\"/>",data:"id",render:function(e){var s='<input type="checkbox" class="ISSUE-CHECK" data-serialize-context="ISSUE-CHECK" name="selectedIssuesList" value="'+e+'" />';return s}},{width:"70",title:'<span data-i18n="tbl.col.title.issue.Severity"></span>',data:"labels","class":"issues labels-all",render:function(e){var s=_.filter(e,function(e){return app.conf.issueSeverityLabels.containsStrIgnoreCase(e)});return app.gitLabIssues.toLabelTags(s).join("<br/>")}},{width:"70",title:'<span data-i18n="tbl.col.title.issue.Status"></span>',data:"labels","class":"issues labels-all",render:function(e){var s=_.filter(e,function(e){return app.conf.issueStatusLabels.containsStrIgnoreCase(e)});return app.gitLabIssues.toLabelTags(s).join("<br/>")}},{width:"100",title:'<span data-i18n="tbl.col.title.issue.assignTo"></span>',render:function(e,s,t){var a=t.assignee||{name:"None",username:"-"};return'<span title="author: '+t.author.name+'">'+(a.name||"None")+" ["+(a.username||"-")+"]"+"</span>"}},{width:"100",title:'<span data-i18n="tbl.col.title.issue.updateDt"></span>',data:"updated_at",render:function(e){return'<span title="UTC: '+e+'">'+app.uiHelper.utcToLocal(e)+"</span>"}},{width:"100",title:'<span data-i18n="tbl.col.title.issue.createdBy"></span>',data:"author",render:function(e,s,t){var a=e||{name:"None",username:"-"};return'<span title="at: '+app.uiHelper.utcToLocal(t.created_at)+'">'+(a.name||"None")+" ["+(a.username||"-")+"]"+"</span>"}},{width:"100",title:'<span data-i18n="tbl.col.title.issue.milestone"></span>',data:"milestone",render:function(e){return spa.findSafe(e,"title","-")}},{width:"50",title:'<span data-i18n="tbl.col.title.issue.priority"></span>',data:"labels","class":"issues labels-all",render:function(e){var s=_.filter(e,function(e){return app.conf.issuePriorityLabels.containsStrIgnoreCase(e)});return app.gitLabIssues.toLabelTags(s).join("<br/>")}},{title:'<span data-i18n="tbl.col.title.issue.title"></span><br/><span data-i18n="tbl.col.title.issue.labels"></span>',data:"title",render:function(e,s,t){var a=app.gitLabIssues.toLabelTags(t.labels);return"#"+t.iid+"("+t.state+"): <b>"+e+"</b><sup data-i18n=\"title:'tbl.col.title.issue.notes'\"> "+t.user_notes_count+"</sup>"+'<br/><div class="issues labels-all">'+a.join(" ")+"</div>"}},{title:"",data:"updated_at"}],drawCallback:function(){app.gitLabIssues.controlActionButtons(e),dt.columnsAdjustNow()},initComplete:function(){$("#container_gitLabIssues").removeClass("hide"),app.gitLabIssues.updateSeverityCounts(),dt.customize(e),app.uiHelper.indicateLoading("#btnIssuesFullRefresh, #btnIssuesFullRefreshLink","remove"),app.gitLabIssues.list(!0)}})},controlActionButtons:function(e){if(dt.updateCheckAllNoneChecboxStatus(e),app.gitLabIssues.controlActionButtonsEnabled){var s=e+"_wrapper",t=$(s),a=t.find("tbody tr.selected"),i=a.length,n=i>0,o=dt.selectedRowData(e),r=t.find("tbody td.VIEW-COL"),l="Closed";if(r.addClass("disabled"),t.closest(".container-component").find("button.ACTION").addClass("hide"),n)if(t.find("tbody :checkbox:checked").length?r.addClass("disabled"):r.removeClass("disabled"),1===i)t.closest(".container-component").find("button.ACTION."+o.Status.toUpperCase()).removeClass("hide");else{var u=t.find("tr.selected td.ISSUE-STATUS").map(function(e,s){return s.innerHTML}),p=u[0],c=_.every(u,function(e){return e.equalsIgnoreCase(p)});c?t.closest(".container-component").find("button.ACTION."+p.toUpperCase()).removeClass("hide"):0>_.indexOf(u,l)&&t.closest(".container-component").find("button.ACTION.-"+l.toUpperCase()).removeClass("hide")}else r.removeClass("disabled")}},showViewPane:function(){var e=$("#container_gitLabIssues"),s=$("#btnLayoutChange i");s.hasClass(app.gitLabIssues.toListLayoutIcon)||(s.toggleClass("columns").toggleClass(app.gitLabIssues.toListLayoutIcon),e.toggleClass("max"),dt.columnsAdjustNow())},toggleLayout:function(){var e=$("#container_gitLabIssues"),s=$("#btnLayoutChange i");if(s.toggleClass("columns").toggleClass(app.gitLabIssues.toListLayoutIcon),e.toggleClass("max"),dt.columnsAdjustNow(),s.hasClass(app.gitLabIssues.toListLayoutIcon)){var t,a=dt.selectedRow(app.gitLabIssues.tableSelector);a&&(t=$(a).data("rowId")),app.gitLabIssues.showDetails(t)}},showDetails:function(e){"use strict";var s=$("#container_gitLabIssues"),t=$("#btnLayoutChange i");if(s.find("#gitLabIssue"),t.hasClass(app.gitLabIssues.toListLayoutIcon)){var a=dt.selectedRowDataByRowId(app.gitLabIssues.tableSelector,e);if(!spa.isBlank(a)){a.rowId=e,a.description=app.uiHelper.updateGitLabImageSrc(a.description);var i={data:a},n=dt.tables[dt.tableKey(app.gitLabIssues.tableSelector)],o=n?n.rows({selected:!0})[0].length:0;if(o>1){var r=$(":checkbox.ISSUE-CHECK:checked").length;r||n.rows(":not([data-issue-id="+a.id+"])").deselect()}app.uiHelper.indicateLoading("#btnIssueFullRefresh","add"),app.gitLabIssues.inViewIssueId=a.id,spa.renderComponent("gitLabIssue",i)}}},updateIssueDetailsInRowData:function(e){var s=e.id||"";if(s){var t=dt.tables[dt.tableKey(app.gitLabIssues.tableSelector)].row("[data-issue-id="+s+"]");if(!spa.isBlank(t)){var a=t.data(),i=_.merge(a,e);spa.isBlank(e.labels)&&(i.labels=[]),console.log("updating table data"),t.data(i),app.gitLabIssue.data=i;var n=dt.getRowBySelector("#gitLabIssues","[data-issue-id="+s+"]");spa.isBlank(n)||n.data("rowData",i)}}},selectedIssueIDs:function(){"use strict";var e=app.gitLabIssues.tableSelector,s=spa.serialize(e+"_wrapper","ISSUE-CHECK").selectedIssuesList;return spa.isBlank(s)?s=[""+dt.selectedRowData(e).iid]:"string"==typeof s&&(s=[s]),s},updateSeverityCounts:function(){var e=$("#container_gitLabIssues");e.find("#btn_Severity_CRITICAL .count").html(app.gitLabIssues.cCount),e.find("#btn_Severity_WARNING .count").html(app.gitLabIssues.wCount)},filterByMine:function(){var e=app.activeGitLab.uName||app.user.storeName||"";app.gitLabIssues.filterByCol(5,e)},filterByAssignToMe:function(){var e=app.activeGitLab.uName||app.user.storeName||"";app.gitLabIssues.filterByCol(3,e)},filterByCol:function(e,s,t){t||dt.clearActiveTableSearch();var a=$(".dataTables_wrapper:visible [data-column-index="+e+"]").find("input[type=search]");if(a.length){var i=t?a.val():"";a.val(i+s).trigger("keyup")}},showHideQuickFilter:function(e){var s=$("#container_gitLabIssues").find(".grid-filters-buttons");e?s.removeClass("hide"):s.addClass("hide")},quickFilter:function(e,s){"use strict";$(e).toggleClass("active"),$(s).removeClass("active");var t=_.map($("#container_gitLabIssues .grid-filters-buttons button.active"),function(e){return $(e).data("filter")}).join("").getRightStr("Severity_");if(dt.clearActiveTableSearch(),t){var a=app.conf.issueLabelsGrp[t];app.gitLabIssues.filterByCol(1,a)}},clearQuickFilter:function(){$("#container_gitLabIssues .grid-filters-buttons button.active").removeClass("active")},openNewIssue:function(){app.uiHelper.openInNewTab(app.activeGitLab.web+"/issues/new")},action:function(e){"use strict";var s=_.map(dt.selectedRowsData(app.gitLabIssues.tableSelector,["LogMessageId"]),function(e){return e.LogMessageId}),t={LogMessageIds:s.join(",")};spa.api.put(spa.api.url("@gitLabIssueDetails",{type:e}),t,function(){dt.reloadDatatable(app.gitLabIssues.tableSelector),app.uiHelper.flyout("success","common.msg.success",{op:"Issue has been."})})}});